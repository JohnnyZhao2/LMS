# 知识中心、测试中心、用户与权限管理需求总结

## 0. 资源版本管理统一规则

- 知识、题目、试卷均视为“资源母版”，每次发布生成不可变的版本记录，字段：`resource_uuid`、`version_number`、`status`、`is_current`、`published_at`。
- 已发布版本禁止原地修改；编辑行为会生成新的版本或草稿，审核/发布后才会成为最新版本，被取代的版本保持只读可查。
- 任务在创建时必须绑定具体的资源版本，并写入 `TaskKnowledge` / `TaskQuiz` 的 JSON 快照（正文、题目结构、分值、及格线、标签等），后续所有学员视图与结果查询仅读取该快照。
- 学员结果与历史任务一经生成即冻结；如果资源需要调整，必须创建新版本并重新发布任务，禁止通过修改母版影响已分发任务。
- 前端在知识中心、测试中心、任务详情等界面展示资源信息时，需优先读取版本字段与快照，避免引用可被覆盖的母版数据。

## 一、知识中心（Knowledge Center）

### 1.1 学员知识中心（Requirement 5）

**功能定位**：学员浏览和筛选知识文档的入口

**核心功能**：
- **知识列表展示**
  - 卡片形式展示知识文档
  - 卡片头部：操作标签（如：重启/隔离/扩容/应急切换）
  - 卡片主体：知识标题 + 内容摘要（2-3行）
  - 卡片底部：修改人 · 修改时间

- **分类筛选体系**
  - 一级筛选（领域大类）：双云/网络/数据库/应用/应急场景/规章制度
  - 二级筛选（系统对象）：选择大类后动态加载对应的系统对象标签
    - 例如：手机银行/数字人民币/核心系统等
  - 操作标签：用于快速识别知识性质

- **知识详情页**
  - 应急类知识：按结构化字段顺序展示（故障场景/触发流程/解决方案/验证方案/恢复方案）
  - 其他类型：Markdown/富文本正文渲染
  - 右侧：自动生成的内容目录（锚点导航）
  - 上下文行为区分：
    - 从学习任务进入：显示「我已学习掌握」按钮
    - 从知识中心进入：仅浏览，不影响任务状态

### 1.2 知识库管理（Requirement 17 - 管理员专属）

**功能定位**：管理员维护知识文档资源

**核心功能**：
- **知识列表管理**
  - 支持搜索和分类筛选
  - 知识文档列表展示

- **知识创建/编辑**
  - 知识类型选择：应急类 / 其他类型
  - 应急类：结构化字段表单
    - 故障场景
    - 触发流程
    - 解决方案
    - 验证方案
    - 恢复方案
  - 其他类型：Markdown 编辑器
  - 分类标签设置：所属条线、所属系统、操作类型

- **知识删除**
  - 确认对话框
  - 被任务引用时禁止删除（Property 12）

**API 端点**：
- `GET /api/knowledge/` - 知识列表（已认证）
- `POST /api/knowledge/` - 创建知识（管理员）
- `GET /api/knowledge/{id}/` - 知识详情（已认证）
- `PATCH /api/knowledge/{id}/` - 更新知识（管理员）
- `DELETE /api/knowledge/{id}/` - 删除知识（管理员）

**关键约束**：
- 知识文档被 TaskKnowledge 引用时禁止删除
- 学员角色仅能浏览，不能创建/编辑/删除

---

## 二、测试中心（Test Center）

**功能定位**：统一的题目与试卷资源池，所有任务均从这里取资源

**使用角色**：导师/室经理/管理员

### 2.1 题目管理（Requirement 12）

**功能定位**：管理题库中的题目，支持快速组卷发布任务

**核心功能**：
- **题目列表**
  - 支持搜索和筛选（题目类型、难度、条线类型、创建者）
  - 题目类型：单选题、多选题、判断题、简答题
  - 展示字段：题目类型、题目内容、条线类型、分值、创建人、创建时间

- **题目创建**
  - 手动创建表单
    - 必填：条线类型、题目类型、题目内容、答案、分值
    - 选择题需填写选项（JSON格式）
    - 可选：解析、难度等级
  - 批量导入（管理员专属）
    - Excel 文件上传
    - 解析 Excel 模板并创建题目记录

- **题目编辑/删除**
  - 权限控制：
    - 导师/室经理：只能编辑/删除自己创建的题目
    - 管理员：可编辑/删除所有题目
  - 删除保护：被试卷引用时禁止删除（Property 13）

- **快速组卷**
  - 多选题目后点击「快速组卷」
  - 跳转到试卷编辑页面，预填充已选题目
  - 后续可继续添加题目或创建新题目

**API 端点**：
- `GET /api/questions/` - 题目列表（导师/室经理/管理员）
- `POST /api/questions/` - 创建题目（导师/室经理/管理员）
- `GET /api/questions/{id}/` - 题目详情
- `PATCH /api/questions/{id}/` - 更新题目（创建者/管理员）
- `DELETE /api/questions/{id}/` - 删除题目（创建者/管理员）
- `POST /api/questions/import/` - 批量导入（管理员）

**关键约束**：
- 题目被 QuizQuestion 引用时禁止删除
- 所有权控制：非创建者（非管理员）无法编辑/删除他人题目
- 题目资源全平台共享，所有角色可查看

### 2.2 试卷管理（Requirement 13）

**功能定位**：题目容器，不包含考试规则，不绑定人员

**核心功能**：
- **试卷列表**
  - 支持搜索
  - 展示字段：试卷名称、题目数量、总分、创建人、创建时间

- **试卷创建/编辑**
  - 基本信息：试卷名称、试卷描述
  - 题目管理：
    - 从题库选择已有题目（可多选）
    - 在创建过程中新建题目（自动纳入题库）
    - 题目顺序调整（拖拽排序）
    - 题目分值调整（可覆盖题目默认分值）
  - 统计信息：总分、题目数量、题型分布

- **试卷编辑/删除**
  - 权限控制：
    - 导师/室经理：只能编辑/删除自己创建的试卷
    - 管理员：可编辑/删除所有试卷（包括标准试卷）
  - 删除保护：被任务引用时禁止删除（Property 14）

- **快速发布任务**
  - 新建试卷完成后：显示「立即发布任务」选项
    - 选择任务类型（练习/考试）
    - 跳转到任务创建流程
  - 单个试卷快速发布：
    - 点击「发布任务」按钮
    - 选择任务类型（练习/考试）
  - 多个试卷快速发布：
    - 勾选多个试卷
    - 点击「快速发布」按钮
    - 仅允许选择练习任务类型（多试卷不支持考试）
    - 跳转到任务创建流程

**API 端点**：
- `GET /api/quizzes/` - 试卷列表（导师/室经理/管理员）
- `POST /api/quizzes/` - 创建试卷（导师/室经理/管理员）
- `GET /api/quizzes/{id}/` - 试卷详情
- `PATCH /api/quizzes/{id}/` - 更新试卷（创建者/管理员）
- `DELETE /api/quizzes/{id}/` - 删除试卷（创建者/管理员）
- `POST /api/quizzes/{id}/add-questions/` - 添加题目

**关键约束**：
- 试卷被 TaskQuiz 引用时禁止删除
- 所有权控制：非创建者（非管理员）无法编辑/删除他人试卷
- 试卷资源全平台共享，所有角色可查看
- 管理员可创建「标准试卷」供全员使用

---

## 三、用户与权限管理（Users & Permissions）

### 3.1 用户认证（Requirement 1）

**功能定位**：用户登录、登出、会话管理

**核心功能**：
- **登录**
  - 用户名和密码输入
  - 调用登录 API 获取 JWT 令牌
  - 存储访问令牌和刷新令牌
  - 登录成功根据角色跳转到对应仪表盘

- **登出**
  - 清除本地存储的令牌
  - 跳转到登录页面

- **Token 刷新**
  - JWT 令牌过期时自动使用刷新令牌获取新令牌
  - 刷新令牌也过期时跳转到登录页面

- **错误处理**
  - 登录失败展示明确错误提示
  - 停用用户登录拒绝（Property 3）

**API 端点**：
- `POST /api/auth/login/` - 用户登录（公开）
- `POST /api/auth/logout/` - 用户登出（已认证）
- `POST /api/auth/refresh/` - 刷新 Token（已认证）

**关键约束**：
- 停用用户（is_active=False）无法登录
- 登录响应包含完整角色列表（Property 2）

### 3.2 角色切换（Requirement 2）

**功能定位**：高权限用户在不同角色间切换

**核心功能**：
- **角色切换器**
  - 高权限用户（导师/室经理/管理员）登录后在顶部导航栏展示
  - 学员角色用户隐藏角色切换器
  - 点击展示该用户所有可用角色列表

- **切换流程**
  - 选择新角色
  - 调用角色切换 API
  - 更新本地令牌
  - 实时刷新菜单、路由和页面内容
  - 清除前一角色的所有状态数据

**API 端点**：
- `POST /api/auth/switch-role/` - 切换角色（已认证）

**关键约束**：
- 角色切换后权限验证基于新角色（Property 4）
- 切换成功后立即生效，禁止跨角色残留数据

### 3.3 用户管理（Requirement 18 - 管理员专属）

**功能定位**：管理员管理平台所有用户

**核心功能**：
- **用户列表**
  - 展示字段：姓名、工号、账号、状态、所属室、角色
  - 支持搜索和筛选

- **用户创建**
  - 用户创建表单
  - 必填：姓名、工号、账号、密码、所属室
  - 角色分配（默认包含学员角色）
  - 新用户默认包含学员角色（Property 5）

- **用户编辑**
  - 编辑用户基本信息
  - 更新用户信息一致性保证（Property 6）

- **用户停用/启用**
  - 停用用户：设置 is_active=False，无法登录
  - 启用用户：设置 is_active=True，可正常登录
  - 状态切换生效（Property 7）

- **密码重置**
  - 确认对话框
  - 生成临时密码并显示

- **角色分配**
  - 角色多选器
  - 学员角色不可取消（Property 9）
  - 支持分配多个角色

- **用户删除**
  - 有数据用户删除保护（Property 8）
  - 已产生 TaskAssignment、Submission 或 SpotCheck 记录的用户禁止删除

**API 端点**：
- `GET /api/users/` - 用户列表（管理员）
- `POST /api/users/` - 创建用户（管理员）
- `GET /api/users/{id}/` - 用户详情（管理员）
- `PATCH /api/users/{id}/` - 更新用户（管理员）
- `POST /api/users/{id}/deactivate/` - 停用用户（管理员）
- `POST /api/users/{id}/activate/` - 启用用户（管理员）
- `POST /api/users/{id}/assign-roles/` - 分配角色（管理员）

**关键约束**：
- 仅管理员可访问
- 新用户必须包含学员角色
- 学员角色不可移除
- 有业务数据的用户禁止删除

### 3.4 组织架构管理（Requirement 19 - 管理员专属）

**功能定位**：维护组织架构和师徒关系

**核心功能**：
- **室管理**
  - 展示室列表和每个室的成员
  - 调整用户所属室
  - 指定室经理
    - 原室经理失去 DEPT_MANAGER 角色
    - 新室经理获得 DEPT_MANAGER 角色
    - 原子性权限转移（Property 11）

- **师徒关系管理**
  - 展示导师列表和每位导师的学员
  - 为学员指定导师
  - 解除师徒关系
  - 师徒关系唯一性：学员同一时间最多只能有一个导师（Property 10）

**API 端点**：
- `POST /api/users/{id}/assign-mentor/` - 指定导师（管理员）
- `GET /api/users/mentees/` - 获取名下学员（导师）
- `GET /api/users/department-members/` - 获取本室成员（室经理）

**关键约束**：
- 仅管理员可管理组织架构
- 师徒关系唯一性保证
- 室经理权限原子性转移

### 3.5 数据访问范围控制

**功能定位**：基于角色的数据隔离

**核心规则**：
- **导师数据范围**（Property 37）
  - 仅能访问 mentor_id 等于该导师 ID 的学员数据
  - 任务创建时分配的学员必须全部是该导师的名下学员（Property 17）

- **室经理数据范围**（Property 38）
  - 仅能访问 department_id 等于该室经理所在室的学员数据
  - 任务创建时分配的学员必须全部是本室成员（Property 18）

- **管理员数据范围**（Property 39）
  - 可访问全平台所有数据
  - 无数据范围限制

- **无权限请求拒绝**（Property 40）
  - 用户对无权访问的资源请求返回 403 状态码

**API 端点**：
- 各种列表查询接口根据角色自动过滤数据范围

**关键约束**：
- 数据范围在 API 层面自动过滤
- 前端仅展示有权限访问的数据
- 跨范围操作请求返回 403 错误

---

## 四、核心设计原则

### 4.1 资源与任务分离
- 知识文档、题目、试卷作为资源先行创建
- 任务作为分配动作后续发布
- 资源可以被多个任务引用

### 4.2 基于角色的访问控制（RBAC）
- 五种角色：学员、导师、室经理、管理员、团队经理
- 不同角色具有不同的数据访问范围
- 权限验证在 API 层面统一处理

### 4.3 数据范围隔离
- 导师：仅访问名下学员数据
- 室经理：访问本室数据
- 管理员：访问全平台数据
- 数据范围在查询时自动过滤

### 4.4 软删除策略
- 关键业务数据支持软删除（is_deleted 字段）
- 保留历史记录
- 被引用的资源禁止删除

### 4.5 所有权控制
- 资源（题目/试卷）的编辑/删除权限基于创建者
- 管理员拥有所有资源的完整权限
- 非创建者（非管理员）无法编辑/删除他人资源

---

## 五、关键属性（Properties）

### 资源引用保护
- **Property 12**: 被引用知识删除保护
- **Property 13**: 被引用题目删除保护（需排除已删除试卷）
- **Property 14**: 被引用试卷删除保护

### 资源所有权
- **Property 15**: 题目所有权编辑控制
- **Property 16**: 试卷所有权编辑控制

### 用户管理
- **Property 5**: 新用户默认学员角色
- **Property 8**: 有数据用户删除保护
- **Property 9**: 学员角色不可移除

### 组织架构
- **Property 10**: 师徒关系唯一性
- **Property 11**: 室经理权限原子转移

### 数据访问范围
- **Property 17**: 导师任务学员范围限制
- **Property 18**: 室经理任务学员范围限制
- **Property 37-39**: 各角色数据范围限制
- **Property 40**: 无权限请求拒绝


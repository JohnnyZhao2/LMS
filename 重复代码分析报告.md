# é‡å¤ä»£ç åˆ†ææŠ¥å‘Š

## æ¦‚è¿°

æœ¬æŠ¥å‘Šåˆ†æäº†å‰åç«¯ä»£ç ä¸­çš„é‡å¤ä»£ç æ¨¡å¼ï¼Œè¯†åˆ«å¯ä»¥æå–ä¸ºå…¬å…±ä»£ç çš„éƒ¨åˆ†ï¼Œä»¥æé«˜ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚

**æ³¨æ„**: å‰ç«¯é‡å¤ä»£ç çš„è¯¦ç»†åˆ†æè¯·å‚è€ƒ [å‰ç«¯é‡å¤ä»£ç åˆ†ææŠ¥å‘Š.md](./å‰ç«¯é‡å¤ä»£ç åˆ†ææŠ¥å‘Š.md)

---

## ä¸€ã€å‰ç«¯é‡å¤ä»£ç åˆ†æ

### 1.1 API å·¥å…·å‡½æ•°é‡å¤

**ä½ç½®**: `lms_frontend/src/lib/api-utils.ts`

**é—®é¢˜**: `buildQueryString` å’Œ `buildQueryParams` å‡½æ•°é€»è¾‘å‡ ä¹å®Œå…¨ç›¸åŒï¼Œåªæ˜¯è¿”å›å€¼æ˜¯å¦åŒ…å« `?` å‰ç¼€ã€‚

```typescript
// å½“å‰å®ç°
export function buildQueryString(params: ...): string {
  const searchParams = new URLSearchParams();
  Object.entries(params).forEach(([key, value]) => {
    if (value !== undefined && value !== null && value !== '') {
      searchParams.set(key, String(value));
    }
  });
  const queryString = searchParams.toString();
  return queryString ? `?${queryString}` : '';
}

export function buildQueryParams(params: ...): string {
  const searchParams = new URLSearchParams();
  Object.entries(params).forEach(([key, value]) => {
    if (value !== undefined && value !== null && value !== '') {
      searchParams.set(key, String(value));
    }
  });
  return searchParams.toString();
}
```

**å»ºè®®**: 
- åˆå¹¶ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œé€šè¿‡å¯é€‰å‚æ•°æ§åˆ¶æ˜¯å¦åŒ…å« `?` å‰ç¼€
- æˆ–è€…ä¿ç•™ `buildQueryParams`ï¼Œåœ¨éœ€è¦æ—¶æ‰‹åŠ¨æ·»åŠ  `?` å‰ç¼€ï¼ˆæ›´çµæ´»ï¼‰

---

### 1.2 è¯¦æƒ…æŸ¥è¯¢ Hook æ¨¡å¼é‡å¤

**ä½ç½®**: å¤šä¸ª `get-*.ts` æ–‡ä»¶

**é—®é¢˜**: å¤šä¸ªè¯¦æƒ…æŸ¥è¯¢ Hook çš„æ¨¡å¼é«˜åº¦ç›¸ä¼¼ï¼š

```typescript
// æ¨¡å¼é‡å¤å‡ºç°äº:
// - get-questions.ts: useQuestionDetail
// - get-quizzes.ts: useQuizDetail  
// - get-admin-knowledge.ts: useKnowledgeDetail
// - get-student-knowledge-detail.ts: useStudentKnowledgeDetail
// - get-grading-detail.ts: useGradingDetail
// - get-users.ts: useUserDetail
// - get-spot-checks.ts: useSpotCheckDetail
// - get-task-detail.ts: useTaskDetail

export const useXxxDetail = (id: number) => {
  return useQuery({
    queryKey: ['xxx-detail', id],
    queryFn: () => apiClient.get<XxxDetail>(`/xxx/${id}/`),
    enabled: !!id,
  });
};
```

**å½“å‰çŠ¶æ€**: âœ… **å¯æ¥å—** - è¿™ç§é‡å¤æ˜¯åˆç†çš„ï¼Œå› ä¸ºï¼š
- æ¯ä¸ª Hook çš„ç±»å‹ä¸åŒï¼ˆXxxDetailï¼‰
- æ¯ä¸ª API ç«¯ç‚¹ä¸åŒ
- åˆ›å»ºé€šç”¨ Hook ä¼šå¢åŠ å¤æ‚æ€§ï¼Œå¯èƒ½å¾—ä¸å¿å¤±
- ä»£ç ç®€æ´æ¸…æ™°ï¼Œæ˜“äºç†è§£

**å»ºè®®**: ä¿æŒç°çŠ¶ï¼Œä¸å»ºè®®è¿‡åº¦æŠ½è±¡

---

### 1.3 åˆ—è¡¨æŸ¥è¯¢ Hook æ¨¡å¼é‡å¤

**ä½ç½®**: å¤šä¸ª `get-*.ts` æ–‡ä»¶

**é—®é¢˜**: åˆ—è¡¨æŸ¥è¯¢ Hook çš„æ¨¡å¼ç›¸ä¼¼ï¼Œä½†å·²é€šè¿‡å·¥å…·å‡½æ•°å¤ç”¨ï¼š

```typescript
// æ¨¡å¼é‡å¤å‡ºç°äº:
// - get-questions.ts: useQuestions
// - get-quizzes.ts: useQuizzes
// - get-tasks.ts: useStudentTasks, useTaskList
// - get-spot-checks.ts: useSpotChecks
// - get-pending-grading.ts: usePendingGrading
// - get-admin-knowledge.ts: useAdminKnowledgeList

export const useXxx = (params: GetXxxParams = {}) => {
  const { page = 1, pageSize = 20, ...otherParams } = params;
  
  return useQuery({
    queryKey: ['xxx', page, pageSize, ...otherParams],
    queryFn: () => {
      const queryParams = {
        ...buildPaginationParams(page, pageSize),
        ...(otherParams && { ...otherParams }),
      };
      const queryString = buildQueryString(queryParams);
      return apiClient.get<PaginatedResponse<Xxx>>(`/xxx/${queryString}`);
    },
  });
};
```

**å½“å‰çŠ¶æ€**: âœ… **è‰¯å¥½** - å·²é€šè¿‡ `buildPaginationParams` å’Œ `buildQueryString` å·¥å…·å‡½æ•°å‡å°‘é‡å¤

**å»ºè®®**: ä¿æŒç°çŠ¶

---

## äºŒã€åç«¯é‡å¤ä»£ç åˆ†æ

### 2.1 è§†å›¾é”™è¯¯å¤„ç†æ¨¡å¼é‡å¤

**ä½ç½®**: å¤šä¸ª `views.py` æ–‡ä»¶

**é—®é¢˜**: BusinessError é”™è¯¯å¤„ç†æ¨¡å¼åœ¨å¤šä¸ªè§†å›¾ä¸­é‡å¤ï¼š

```python
# æ¨¡å¼é‡å¤å‡ºç°äº:
# - quizzes/views.py (10+ å¤„)
# - knowledge/views/knowledge.py (8+ å¤„)
# - spot_checks/views.py (5+ å¤„)
# - questions/views.py
# - submissions/views/*.py
# - notifications/views.py

try:
    result = self.service.xxx(...)
except BusinessError as e:
    return Response(
        {'code': e.code, 'message': e.message, 'details': e.details},
        status=status.HTTP_400_BAD_REQUEST if e.code == 'VALIDATION_ERROR'
        else status.HTTP_403_FORBIDDEN
    )
```

**å»ºè®®**: 
- åˆ›å»ºä¸€ä¸ªè£…é¥°å™¨æˆ– Mixin æ¥å¤„ç† BusinessError
- æˆ–è€…åˆ›å»ºä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼

**ç¤ºä¾‹å®ç°**:
```python
# core/decorators.py æˆ– core/mixins.py
from functools import wraps
from rest_framework.response import Response
from rest_framework import status
from core.exceptions import BusinessError, ErrorCodes

def handle_business_error(view_func):
    @wraps(view_func)
    def wrapper(*args, **kwargs):
        try:
            return view_func(*args, **kwargs)
        except BusinessError as e:
            status_code = (
                status.HTTP_400_BAD_REQUEST if e.code == ErrorCodes.VALIDATION_ERROR
                else status.HTTP_403_FORBIDDEN if e.code == ErrorCodes.PERMISSION_DENIED
                else status.HTTP_404_NOT_FOUND if e.code == ErrorCodes.RESOURCE_NOT_FOUND
                else status.HTTP_400_BAD_REQUEST
            )
            return Response(
                {'code': e.code, 'message': e.message, 'details': e.details},
                status=status_code
            )
    return wrapper
```

**ä¼˜å…ˆçº§**: ğŸ”´ **é«˜** - å½±å“èŒƒå›´å¹¿ï¼Œå¯æ˜¾è‘—å‡å°‘é‡å¤ä»£ç 

---

### 2.2 åˆ†é¡µå¤„ç†æ¨¡å¼é‡å¤

**ä½ç½®**: å¤šä¸ª `views.py` æ–‡ä»¶

**é—®é¢˜**: åˆ†é¡µå¤„ç†ä»£ç åœ¨å¤šä¸ªè§†å›¾ä¸­é‡å¤ï¼š

```python
# æ¨¡å¼é‡å¤å‡ºç°äº:
# - knowledge/views/knowledge.py (2 å¤„)
# - quizzes/views.py (1 å¤„)

paginator = StandardResultsSetPagination()
page = paginator.paginate_queryset(queryset, request)
if page is not None:
    serializer = XxxListSerializer(page, many=True)
    return paginator.get_paginated_response(serializer.data)

serializer = XxxListSerializer(queryset, many=True)
return Response(serializer.data, status=status.HTTP_200_OK)
```

**æ³¨æ„**: `questions/views.py` ä¸­ä½¿ç”¨äº†ä¸åŒçš„åˆ†é¡µæ¨¡å¼ï¼ˆåœ¨ Service å±‚å¤„ç†åˆ†é¡µï¼‰

**å»ºè®®**: 
- åˆ›å»ºä¸€ä¸ª Mixin æˆ–è¾…åŠ©å‡½æ•°æ¥å¤„ç†åˆ†é¡µ
- æˆ–è€…åœ¨è§†å›¾ç±»ä¸­ä½¿ç”¨ DRF çš„ `ListAPIView`ï¼ˆå¦‚æœé€‚åˆï¼‰

**ç¤ºä¾‹å®ç°**:
```python
# core/mixins.py
class PaginatedResponseMixin:
    def get_paginated_response(self, queryset, serializer_class, request):
        paginator = StandardResultsSetPagination()
        page = paginator.paginate_queryset(queryset, request)
        if page is not None:
            serializer = serializer_class(page, many=True)
            return paginator.get_paginated_response(serializer.data)
        serializer = serializer_class(queryset, many=True)
        return Response(serializer.data, status=status.HTTP_200_OK)
```

**ä¼˜å…ˆçº§**: ğŸŸ¡ **ä¸­** - é‡å¤æ¬¡æ•°è¾ƒå°‘ï¼Œä½†ä»æœ‰æ”¹è¿›ç©ºé—´

---

### 2.3 è§†å›¾åˆå§‹åŒ–æ¨¡å¼é‡å¤

**ä½ç½®**: å¤šä¸ª `views.py` æ–‡ä»¶

**é—®é¢˜**: Service åˆå§‹åŒ–çš„æ¨¡å¼é‡å¤ï¼š

```python
# æ¨¡å¼é‡å¤å‡ºç°äºå¤§å¤šæ•°è§†å›¾ç±»ä¸­

class XxxView(APIView):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.service = XxxService()
```

**å½“å‰çŠ¶æ€**: âœ… **å¯æ¥å—** - è¿™ç§æ¨¡å¼ç®€æ´æ˜äº†ï¼Œæ˜“äºç†è§£

**å»ºè®®**: ä¿æŒç°çŠ¶ï¼Œä¸å»ºè®®è¿‡åº¦æŠ½è±¡

---

### 2.4 Service å±‚ validate_not_none è°ƒç”¨é‡å¤

**ä½ç½®**: å¤šä¸ª `services.py` æ–‡ä»¶

**é—®é¢˜**: `validate_not_none` çš„è°ƒç”¨æ¨¡å¼é‡å¤ï¼š

```python
# æ¨¡å¼é‡å¤å‡ºç°äº:
# - tasks/services.py
# - submissions/services.py
# - knowledge/services.py
# - questions/services.py
# - quizzes/services.py
# - spot_checks/services.py
# - users/services.py
# - notifications/services.py

def get_by_id(self, pk: int, user=None) -> Xxx:
    xxx = self.repository.get_by_id(pk, include_deleted=include_deleted)
    self.validate_not_none(xxx, f'èµ„æº {pk} ä¸å­˜åœ¨')
    return xxx
```

**å½“å‰çŠ¶æ€**: âœ… **è‰¯å¥½** - å·²é€šè¿‡ `BaseService.validate_not_none` æ–¹æ³•å¤ç”¨

**å»ºè®®**: ä¿æŒç°çŠ¶

---

## ä¸‰ã€å‰åç«¯ä¹‹é—´çš„é‡å¤é€»è¾‘

### 3.1 åˆ†é¡µå‚æ•°å¤„ç†

**å‰ç«¯**: ä½¿ç”¨ `buildPaginationParams(page, pageSize)` ç”Ÿæˆ `{page: "1", page_size: "20"}`

**åç«¯**: ä½¿ç”¨ `StandardResultsSetPagination` å¤„ç† `page` å’Œ `page_size` æŸ¥è¯¢å‚æ•°

**çŠ¶æ€**: âœ… **æ­£å¸¸** - è¿™æ˜¯å‰åç«¯åˆ†ç¦»çš„æ­£å¸¸æƒ…å†µï¼Œä¸æ˜¯é‡å¤ä»£ç 

---

### 3.2 é”™è¯¯å“åº”æ ¼å¼

**å‰ç«¯**: æœŸæœ›é”™è¯¯å“åº”æ ¼å¼ä¸º `{code, message, details?}`

**åç«¯**: è¿”å›é”™è¯¯å“åº”æ ¼å¼ä¸º `{'code': e.code, 'message': e.message, 'details': e.details}`

**çŠ¶æ€**: âœ… **æ­£å¸¸** - è¿™æ˜¯ API å¥‘çº¦ï¼Œä¸æ˜¯é‡å¤ä»£ç 

---

## å››ã€æ€»ç»“ä¸å»ºè®®

### 4.1 éœ€è¦æ”¹è¿›çš„é‡å¤ä»£ç 

1. **âœ… å·²å®Œæˆ - åç«¯è§†å›¾é”™è¯¯å¤„ç†æ¨¡å¼** (2.1)
   - **çŠ¶æ€**: å·²åˆ›å»º `BusinessErrorHandlerMixin`
   - **ä½ç½®**: `lms_backend/core/mixins.py`
   - **ç¤ºä¾‹åº”ç”¨**: `lms_backend/apps/quizzes/views.py` ä¸­çš„æ‰€æœ‰è§†å›¾ç±»
   - **ä½¿ç”¨æ–¹æ³•**: 
     ```python
     from core.mixins import BusinessErrorHandlerMixin
     
     class MyView(BusinessErrorHandlerMixin, APIView):
         def post(self, request):
             try:
                 result = self.service.create(...)
             except BusinessError as e:
                 return self.handle_business_error(e)
     ```
   - **ä¸‹ä¸€æ­¥**: å¯ä»¥é€æ­¥åœ¨å…¶ä»–è§†å›¾æ–‡ä»¶ä¸­åº”ç”¨æ­¤ Mixinï¼ˆknowledge, spot_checks, questions ç­‰ï¼‰

2. **ğŸŸ¡ ä¸­ä¼˜å…ˆçº§**:
   - **åç«¯åˆ†é¡µå¤„ç†æ¨¡å¼** (2.2) - åˆ›å»º Mixin æˆ–è¾…åŠ©å‡½æ•°
   - **å‰ç«¯ API å·¥å…·å‡½æ•°** (1.1) - åˆå¹¶ `buildQueryString` å’Œ `buildQueryParams`

### 4.2 å¯æ¥å—çš„é‡å¤ä»£ç 

ä»¥ä¸‹é‡å¤æ˜¯åˆç†çš„ï¼Œä¸å»ºè®®è¿‡åº¦æŠ½è±¡ï¼š
- å‰ç«¯è¯¦æƒ…æŸ¥è¯¢ Hook æ¨¡å¼ (1.2) - æ¯ä¸ª Hook çš„ç±»å‹å’Œç«¯ç‚¹ä¸åŒ
- å‰ç«¯åˆ—è¡¨æŸ¥è¯¢ Hook æ¨¡å¼ (1.3) - å·²é€šè¿‡å·¥å…·å‡½æ•°å¤ç”¨
- åç«¯è§†å›¾åˆå§‹åŒ–æ¨¡å¼ (2.3) - æ¨¡å¼ç®€æ´æ¸…æ™°
- åç«¯ Service validate_not_none è°ƒç”¨ (2.4) - å·²é€šè¿‡ BaseService å¤ç”¨

### 4.3 æ”¹è¿›è¿›åº¦

1. âœ… **å·²å®Œæˆ**: åˆ›å»ºåç«¯é”™è¯¯å¤„ç† Mixinï¼ˆ`BusinessErrorHandlerMixin`ï¼‰
   - å·²åœ¨ `quizzes/views.py` ä¸­åº”ç”¨å¹¶éªŒè¯
   - å¯ä»¥é€æ­¥åº”ç”¨åˆ°å…¶ä»–è§†å›¾æ–‡ä»¶ï¼ˆknowledge, spot_checks, questions ç­‰ï¼‰

2. **å¾…å¤„ç†**: åˆ›å»ºåç«¯åˆ†é¡µå¤„ç† Mixinï¼ˆå¯é€‰ï¼‰
3. **å¾…å¤„ç†**: ä¼˜åŒ–å‰ç«¯ API å·¥å…·å‡½æ•°ï¼ˆå¯é€‰ï¼‰

---

## äº”ã€ä»£ç è´¨é‡è¯„ä¼°

æ€»ä½“è€Œè¨€ï¼Œä»£ç åº“çš„é‡å¤ä»£ç æ§åˆ¶å¾—**è¾ƒå¥½**ï¼š

âœ… **ä¼˜ç‚¹**:
- å·²é€šè¿‡ BaseServiceã€BaseRepository ç­‰åŸºç±»å¤ç”¨é€šç”¨é€»è¾‘
- å‰ç«¯å·²é€šè¿‡å·¥å…·å‡½æ•°ï¼ˆbuildPaginationParams, buildQueryStringï¼‰å‡å°‘é‡å¤
- å¤§éƒ¨åˆ†é‡å¤æ˜¯åˆç†çš„ä¸šåŠ¡æ¨¡å¼é‡å¤ï¼Œè€Œéå¯ä»¥æå–çš„é€šç”¨ä»£ç 

âš ï¸ **æ”¹è¿›ç©ºé—´**:
- åç«¯è§†å›¾çš„é”™è¯¯å¤„ç†å¯ä»¥è¿›ä¸€æ­¥æŠ½è±¡
- åç«¯åˆ†é¡µå¤„ç†å¯ä»¥ç»Ÿä¸€åŒ–

**æ€»ä½“è¯„åˆ†**: 8/10 - ä»£ç è´¨é‡è‰¯å¥½ï¼Œæœ‰æ”¹è¿›ç©ºé—´ä½†æ— ä¸¥é‡é—®é¢˜

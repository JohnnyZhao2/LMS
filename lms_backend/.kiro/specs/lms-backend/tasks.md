# Implementation Plan

- [x] 1. 项目初始化与核心配置
  - [x] 1.1 创建 Django 项目结构
    - 创建 `config/` 配置目录和 `apps/` 应用目录
    - 配置 `settings/base.py`、`settings/development.py`、`settings/production.py`
    - 配置 MySQL 数据库连接
    - 配置 Django REST Framework 和 JWT 认证
    - _Requirements: 1.1_
  - [x] 1.2 创建核心模块
    - 创建 `core/` 目录，包含 `permissions.py`、`pagination.py`、`exceptions.py`、`mixins.py`、`utils.py`
    - 实现通用异常处理和错误响应格式
    - 实现通用分页配置
    - _Requirements: 22.5_
  - [x] 1.3 配置测试框架
    - 配置 pytest、pytest-django、hypothesis
    - 创建 `tests/conftest.py` 和 `tests/factories.py`
    - 创建 `tests/strategies.py` 用于 hypothesis 策略
    - _Requirements: 全部_

- [ ] 2. 用户与认证模块
  - [x] 2.1 实现用户模型
    - 创建 `apps/users/models.py`，定义 User、Role、UserRole、Department 模型
    - 实现用户基础字段（employee_id、real_name、department、mentor）
    - 实现角色关联和师徒关系
    - _Requirements: 2.1, 3.4_
  - [ ]* 2.2 编写用户模型属性测试
    - **Property 5: 新用户默认学员角色**
    - **Property 9: 学员角色不可移除**
    - **Property 10: 师徒关系唯一性**
    - **Validates: Requirements 2.1, 2.6, 3.4, 3.5, 3.6**
  - [x] 2.3 实现认证服务
    - 创建 `apps/users/services.py`，实现登录、登出、角色切换逻辑
    - 实现 JWT token 生成和验证
    - 实现停用用户登录拒绝
    - _Requirements: 1.1, 1.2, 1.3, 1.5_
  - [ ]* 2.4 编写认证属性测试
    - **Property 1: 有效凭证登录成功**
    - **Property 2: 登录返回完整角色列表**
    - **Property 3: 停用用户登录拒绝**
    - **Property 4: 角色切换权限生效**
    - **Validates: Requirements 1.1, 1.2, 1.3, 1.5, 22.4**
  - [x] 2.5 实现认证 API
    - 创建 `apps/users/views.py`，实现登录、登出、刷新 token、切换角色端点
    - 创建 `apps/users/serializers.py`，定义请求/响应序列化器
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.6_
  - [x] 2.6 实现用户管理 API
    - 实现用户 CRUD 端点（创建、查询、更新）
    - 实现用户停用/启用端点
    - 实现角色分配端点
    - 实现导师指定端点
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 3.4, 3.5, 3.6_
  - [ ]* 2.7 编写用户管理属性测试
    - **Property 6: 用户信息更新一致性**
    - **Property 7: 用户停用/启用状态切换**
    - **Property 8: 有数据用户删除保护**
    - **Property 11: 室经理权限原子转移**
    - **Validates: Requirements 2.2, 2.3, 2.4, 2.5, 3.2, 3.3**
  - [x] 2.8 Checkpoint - 确保所有测试通过
    - Ensure all tests pass, ask the user if questions arise.

- [ ] 3. 权限控制模块
  - [x] 3.1 实现权限类
    - 创建 `apps/users/permissions.py`，定义角色权限类
    - 实现 IsAdmin、IsMentor、IsDeptManager、IsTeamManager 权限类
    - 实现 IsOwnerOrAdmin 权限类（资源所有权控制）
    - _Requirements: 22.1, 22.2, 22.3, 22.4, 22.5_
  - [ ] 3.2 实现数据范围过滤
    - 实现导师数据范围过滤（仅名下学员）
    - 实现室经理数据范围过滤（仅本室成员）
    - 实现管理员全平台数据访问
    - _Requirements: 22.1, 22.2, 22.3_
  - [ ]* 3.3 编写权限属性测试
    - **Property 37: 导师数据范围限制**
    - **Property 38: 室经理数据范围限制**
    - **Property 39: 管理员全平台数据访问**
    - **Property 40: 无权限请求拒绝**
    - **Property 41: 团队经理只读访问**
    - **Validates: Requirements 22.1, 22.2, 22.3, 22.5, 21.3**
  - [ ] 3.4 Checkpoint - 确保所有测试通过
    - Ensure all tests pass, ask the user if questions arise.

- [ ] 4. 知识文档模块
  - [ ] 4.1 实现知识模型
    - 创建 `apps/knowledge/models.py`，定义 Knowledge、KnowledgeCategory、KnowledgeCategoryRelation 模型
    - 实现知识类型（EMERGENCY/OTHER）
    - 实现结构化字段（故障场景/触发流程/解决方案/验证方案/恢复方案）
    - _Requirements: 4.1, 4.2, 4.3_
  - [ ] 4.2 实现知识管理 API
    - 创建 `apps/knowledge/views.py`、`apps/knowledge/serializers.py`
    - 实现知识 CRUD 端点
    - 实现分类管理端点
    - 实现删除保护（被任务引用时禁止删除）
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
  - [ ]* 4.3 编写知识模块属性测试
    - **Property 12: 被引用知识删除保护**
    - **Validates: Requirements 4.5**

- [ ] 5. 题库模块
  - [ ] 5.1 实现题目模型
    - 创建 `apps/questions/models.py`，定义 Question 模型
    - 实现题目类型（单选/多选/判断/简答）
    - 实现题目内容、答案、解析字段
    - _Requirements: 5.1_
  - [ ] 5.2 实现题目管理 API
    - 创建 `apps/questions/views.py`、`apps/questions/serializers.py`
    - 实现题目 CRUD 端点
    - 实现所有权控制（仅创建者或管理员可编辑/删除）
    - 实现批量导入端点
    - 实现删除保护（被试卷引用时禁止删除）
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_
  - [ ]* 5.3 编写题目模块属性测试
    - **Property 13: 被引用题目删除保护**
    - **Property 15: 题目所有权编辑控制**
    - **Validates: Requirements 5.3, 5.4, 5.5, 5.7**
  - [ ] 5.4 Checkpoint - 确保所有测试通过
    - Ensure all tests pass, ask the user if questions arise.

- [ ] 6. 试卷模块
  - [ ] 6.1 实现试卷模型
    - 创建 `apps/quizzes/models.py`，定义 Quiz、QuizQuestion 模型
    - 实现试卷与题目的多对多关系
    - _Requirements: 6.1, 6.2_
  - [ ] 6.2 实现试卷管理 API
    - 创建 `apps/quizzes/views.py`、`apps/quizzes/serializers.py`
    - 实现试卷 CRUD 端点
    - 实现添加题目端点（支持选择已有题目或新建题目）
    - 实现所有权控制
    - 实现删除保护（被任务引用时禁止删除）
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8_
  - [ ]* 6.3 编写试卷模块属性测试
    - **Property 14: 被引用试卷删除保护**
    - **Property 16: 试卷所有权编辑控制**
    - **Validates: Requirements 6.5, 6.6, 6.7, 6.8**

- [ ] 7. 任务模块
  - [ ] 7.1 实现任务模型
    - 创建 `apps/tasks/models.py`，定义 Task、TaskAssignment、TaskKnowledge、TaskQuiz 模型
    - 实现任务类型（LEARNING/PRACTICE/EXAM）
    - 实现任务状态（进行中/已完成/已逾期/待考试）
    - _Requirements: 7.1, 9.1, 11.1_
  - [ ] 7.2 实现学习任务 API
    - 创建学习任务端点
    - 实现学员范围验证（导师/室经理/管理员）
    - 实现任务分配记录创建
    - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_
  - [ ]* 7.3 编写学习任务属性测试
    - **Property 17: 导师任务学员范围限制**
    - **Property 18: 室经理任务学员范围限制**
    - **Property 19: 任务分配记录完整性**
    - **Validates: Requirements 7.2, 7.3, 9.2, 9.3, 11.3, 11.4, 7.5, 9.5, 11.6**
  - [ ] 7.4 实现练习任务 API
    - 创建练习任务端点
    - 实现试卷和知识文档关联
    - 实现学员范围验证
    - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_
  - [ ] 7.5 实现考试任务 API
    - 创建考试任务端点
    - 实现考试规则设置（时间窗口、时长、及格分数）
    - 实现唯一试卷验证
    - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6_
  - [ ]* 7.6 编写考试任务属性测试
    - **Property 27: 考试任务唯一试卷**
    - **Validates: Requirements 11.1**
  - [ ] 7.7 实现任务管理 API
    - 实现任务列表查询（支持角色数据范围过滤）
    - 实现任务详情查询
    - 实现强制结束任务端点
    - _Requirements: 7.6, 20.1, 20.2, 20.3_
  - [ ] 7.8 Checkpoint - 确保所有测试通过
    - Ensure all tests pass, ask the user if questions arise.

- [ ] 8. 任务执行模块
  - [ ] 8.1 实现学习任务执行 API
    - 实现学员任务列表查询
    - 实现知识学习完成端点
    - 实现学习任务自动完成逻辑
    - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_
  - [ ]* 8.2 编写学习任务执行属性测试
    - **Property 20: 知识学习完成记录**
    - **Property 21: 学习任务自动完成**
    - **Property 22: 知识浏览不影响任务**
    - **Property 23: 任务逾期状态标记**
    - **Validates: Requirements 8.3, 8.5, 8.6, 8.7**

- [ ] 9. 答题与评分模块
  - [ ] 9.1 实现答题模型
    - 创建 `apps/submissions/models.py`，定义 Submission、Answer 模型
    - 实现答题状态（已提交/待评分/已评分）
    - 实现答案记录和评分字段
    - _Requirements: 10.2, 12.2_
  - [ ] 9.2 实现练习答题 API
    - 实现开始练习端点
    - 实现保存答案端点
    - 实现提交答卷端点
    - 实现客观题自动评分
    - 实现多次练习支持
    - _Requirements: 10.2, 10.3, 10.4, 10.5, 10.6, 10.7_
  - [ ]* 9.3 编写练习答题属性测试
    - **Property 24: 练习允许多次提交**
    - **Property 25: 练习任务自动完成**
    - **Property 26: 已完成练习仍可继续**
    - **Property 30: 客观题自动评分**
    - **Validates: Requirements 10.3, 10.5, 10.6, 10.7, 12.4**
  - [ ] 9.4 实现考试答题 API
    - 实现开始考试端点（时间窗口验证）
    - 实现考试计时和自动提交
    - 实现单次提交限制
    - 实现主观题待评分状态
    - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7, 12.8_
  - [ ]* 9.5 编写考试答题属性测试
    - **Property 28: 考试时间窗口控制**
    - **Property 29: 考试单次提交限制**
    - **Property 31: 主观题待评分状态**
    - **Property 32: 纯客观题直接完成**
    - **Validates: Requirements 12.5, 12.6, 12.7, 12.8**
  - [ ] 9.6 实现评分 API
    - 实现待评分列表查询
    - 实现主观题评分端点
    - 实现评分完成状态转换
    - _Requirements: 13.1, 13.2, 13.3, 13.4, 13.5_
  - [ ]* 9.7 编写评分属性测试
    - **Property 33: 评分完成状态转换**
    - **Property 34: 未完成评分状态保持**
    - **Validates: Requirements 13.4, 13.5**
  - [ ] 9.8 Checkpoint - 确保所有测试通过
    - Ensure all tests pass, ask the user if questions arise.

- [ ] 10. 抽查模块
  - [ ] 10.1 实现抽查模型
    - 创建 `apps/spot_checks/models.py`，定义 SpotCheck 模型
    - 实现抽查记录字段（学员、内容、评分、评语）
    - _Requirements: 14.1_
  - [ ] 10.2 实现抽查 API
    - 创建 `apps/spot_checks/views.py`、`apps/spot_checks/serializers.py`
    - 实现抽查记录 CRUD 端点
    - 实现学员范围验证
    - 实现时间倒序排列
    - _Requirements: 14.1, 14.2, 14.3, 14.4_
  - [ ]* 10.3 编写抽查模块属性测试
    - **Property 35: 抽查学员范围限制**
    - **Property 36: 抽查记录时间排序**
    - **Validates: Requirements 14.2, 14.3, 14.4**

- [ ] 11. 仪表盘与统计模块
  - [ ] 11.1 实现学员仪表盘 API
    - 创建 `apps/analytics/views.py`、`apps/analytics/serializers.py`
    - 实现待办任务列表查询
    - 实现最新知识文档查询
    - _Requirements: 15.1, 15.2, 15.3_
  - [ ] 11.2 实现学员知识中心 API
    - 实现知识列表查询（支持分类筛选）
    - 实现动态二级分类加载
    - 实现知识详情查询
    - _Requirements: 16.1, 16.2, 16.3, 16.4, 16.5, 16.6_
  - [ ] 11.3 实现学员任务中心 API
    - 实现任务列表查询（支持类型和状态筛选）
    - 实现任务详情跳转
    - _Requirements: 17.1, 17.2, 17.3_
  - [ ] 11.4 实现学员个人中心 API
    - 实现个人信息查询
    - 实现历史成绩查询
    - 实现错题本查询
    - 实现记录导出
    - _Requirements: 18.1, 18.2, 18.3, 18.4_
  - [ ] 11.5 实现导师/室经理仪表盘 API
    - 实现所辖学员完成率和平均分统计
    - 实现待评分考试数量统计
    - _Requirements: 19.1, 19.2, 19.3, 19.4_
  - [ ] 11.6 实现团队经理数据看板 API
    - 实现各室完成率与成绩对比
    - 实现知识热度统计
    - 实现只读访问控制
    - _Requirements: 21.1, 21.2, 21.3_
  - [ ] 11.7 Checkpoint - 确保所有测试通过
    - Ensure all tests pass, ask the user if questions arise.

- [ ] 12. 通知模块
  - [ ] 12.1 实现通知模型
    - 创建 `apps/notifications/models.py`，定义 Notification 模型
    - 实现通知类型（任务分配/截止提醒/评分完成/抽查）
    - _Requirements: 7.5, 9.5, 11.6_
  - [ ] 12.2 实现通知服务
    - 创建 `apps/notifications/services.py`
    - 实现任务分配通知
    - 实现截止时间提醒
    - 实现评分完成通知
    - 预留公司机器人对接接口
    - _Requirements: 7.5, 9.5, 11.6_
  - [ ] 12.3 实现通知 API
    - 实现通知列表查询
    - 实现标记已读端点
    - 实现未读数量查询
    - _Requirements: 7.5, 9.5, 11.6_

- [ ] 13. API 文档与最终验证
  - [ ] 13.1 配置 API 文档
    - 配置 drf-spectacular
    - 生成 OpenAPI 3.0 文档
    - _Requirements: 全部_
  - [ ]* 13.2 编写集成测试
    - 编写端到端 API 测试
    - 验证完整业务流程
    - _Requirements: 全部_
  - [ ] 13.3 Final Checkpoint - 确保所有测试通过
    - Ensure all tests pass, ask the user if questions arise.
